---
title: 单片机基础
updated: 2021-11-21 03:35:32Z
created: 2021-10-09 00:31:02Z
latitude: 23.16770400
longitude: 113.33431200
altitude: 43.6089
---

# 单片机基础

本课程以80C51为例进行介绍。

## 什么是单片机

将微型计算机的基本功能部件：CPU、存储器、I/O 接口、定时器/计数器、中断系统等集成在一个芯片上，这种芯片就称为单片机。

## 单片机的应用领域

- 智能仪器仪表
- 工业控制
- 家用电器
- 机电一体化产品

## 开发工具

### 仿真器

- 南京伟福公司 的伟福仿真器
- 广州周立功公司的 TKS

### 编程器

- SUPERPRO
- EasyPRO

## 嵌入式系统

以嵌入式应用为目的的计算机系统称为[[嵌入式系统]]。

## 单片机的组成

CPU、ROM、RAM、并行I/O、串行口、16位定时器、中断系统、振荡器等。

- 4KB ROM
- 256B RAM / SFR
- 64 KB 的扩展总线
- 2 × 16 位的定时器 / 计数器

### PC

16 位的地址寄存器，CPU 根据它的地址从存储器中取指令。

## I/O 口

P0：数据线、地址线低位，作为输入时必须先置 1 ，作为输出要接上拉电阻。
P1：带上拉电阻，输入时先置 1 。
P2：地址线高位
P3：具有多种第二功能

I/O 口作为输入时必须先置 1

### P3 口的第二功能

引脚|第二功能
-----|-----
0|RXD
1|TXD
2|INT0'
3|INT1'
4|T0
5|T1
6|WR'
7|RD'

## 存储

寄存器区为 00H~1FH，每八个为一组，通过 RS 来选择。

位存储区为 20H~2FH，位地址依次为 00H~7FH

## 时序周期

晶振常用12MHz、11.0592MHz (定时更精确)

1 机器周期 = 6 状态周期 = 12 时钟周期

## 堆栈

最好令 SP = 30H 之后

可用堆栈的最大深度为 80 个单元

## 复位

复位条件是 RST 保持高电平两个机器周期以上。

复位后，PC = 0000H, SP = 07H, P0~P3 = 0FFH

### 复位电路

- 积分电路型  
  产生低电平复位信号
- 微分电路型  
  产生高电平复位信号
  
## 低功耗工作模式
  
低功耗模式有两种：待机模式和掉电模式。
  
### 待机模式 (Idle Mode)
  
将 IDL 置 1，进入待机模式，关闭 CPU，外围电路能正常工作。
  
退出方式有中断和复位。
  
中断会自动将 IDL 清零，所以只需 RETI 即可，当然也可以执行其它 ISR。
  
### 掉电模式 (Power Down Mode)
  
PD = 1，进入掉电模式，此时振荡器停振，但 RAM 的内容能保存，退出只能通过复位。

## 指令系统

### 寻址方式

- 立即寻址  #23H ：直接给出操作数
- 直接寻址  23H ：给出地址中的内容
- 寄存器寻址  R0 ：给出寄存器的内容
- 寄存器间接寻址  @R0 ：以寄存器的内容为地址取出的内容，**只能用 R0 和 R1，以及 DPTR**
- 变址寻址  @A + PC 
- 相对寻址  SJMP rel ：PC + 2 + rel
- 位寻址

### 常用寄存器的标识符

- A
- DPTR  唯一的 16 位寄存器。

DPH DPL

### 常用指令

#### 传送类

- MOV
  ![7e6d6e94cf3444e62050f0e64afc9de3.png](7e6d6e94cf3444e62050f0e64afc9de3.png)
- MOVX  片外 RAM
  > 只能用寄存器间接寻址 (@Ri / @DPTR)  ，必须用 A

#### 交换

- XCH A, <Rn | direct | @Ri>  全字节交换
- XCHD A, @Ri  低 4 直接交换
- SWAP A  低 4 与 高 4 交换，只能用 A

#### 栈操作

- PUSH  ACC
- POP  ACC

#### 算术类

- ADD  不带进位加法
- ADDC  带进位加法
- INC  :  + 1
- DEC  :  - 1
	> INC 和 DEC 不改变标志位
- DA  BCD码的十进制调整
- SUBB  带借位减法
- MUL  AB  :  乘法
- DIV  AB  :  除法

##### 溢出判断

无符号数溢出 Cy = 1 

有符号数溢出；乘法时，结果超过一字节；除法时，除数为零， OV = 1

> -128(1000 0000 B) + 128(1000 0000 B) = 0，Cy = 1，OV = 1

#### 逻辑运算类

- ANL  与
- ORL  或
- XRL  异或

#### A 操作

- RL  循环左移
- RR  循环右移
- RLC  带进位 ...
- RRC
- CPL <A | C>  取反
- CLR <A | C>  清零

#### 跳转

- LJMP  addr16
- AJMP  addr11
- SJMP  rel
- JMP  @A + DPTR

#### 条件跳转

- JZ
- JNZ
- CJNE
- DJNZ
- J(N)B
- J(N)C
- JBC 是 1 则跳转并清零

#### 位操作

- SETB
- CLR
- CPL  取反

### 伪指令

- ORG : 汇编起始地址
- END : 结束汇编
- EQU : 类似宏定义
- DB : 定义字节
- DW : 定义字 (16 bit)
- DS : 预留存储单元
- BIT : 宏定义位

## 中断

### 中断向量

中断名称|中断向量
-------|--------
外部中断0|0003H
定时器0中断|000BH
外部中断1|0013H
定时器1中断|001BH
串行发送中断|0023H
串行接收中断|0023H

### 优先级

用 IP 控制，若同级则按固定顺序执行。

> 固定优先级为 EX0 -> T0 -> EX1 -> T1 -> S

### 中断响应时间

中断响应需要 3 ~ 8 个机器周期。

查询占 1 个机器周期，LCALL 占 2 个机器周期。

若查询时开始执行 RET、RETI、访问 IE、IP 的指令，则要执行完再执行一条指令再中断响应。

## 定时器 / 计数器

定时器 / 计数器是内部中断的一种。

通过 C / T' 可以选择定时器还是计数器。

门控位 GATE 可以控制启停方式。清零时，仅有 TR 控制；置一时，由 TR 和 INT' 相与控制。

### 工作方式

定时器有 4 种工作方式，分别为 0 ~ 3 。

#### 方式 0

方式 0 是用 13 位计数，使用 TH 和 TL 的低 5 位。

## 串行通信

发送寄存器 SBUF (TX)  
接收寄存器 SBUF (RX)  
它们的地址都是 99H 用 SBUF 表示

发送引脚 TXD (P3.1)  

### 波特率

- 方式 0 ：fosc/12
- 方式 2 ：fosc/64(SMOD = 0) 或 fosc/32 (SMOD = 1)
- 方式 1 和 3 ：由定时器 T1 决定 $2^{SMOD} / 32 / 溢出周期$

## 多机通讯

1. 所有从机 SM2 = 1，主机发送地址帧 （RB8=1），所有从机接收并与自己的地址比较。
2. 被选中的从机回答主机并设 SM2=0, 其他从机不变。  
3. 主机发数据帧（RB8=0），只有 SM2=0 的从机能接收。

## 通讯协议

MODBUS

## 程序存储器扩展方法

- 线选法
- 地址译码法

## 扩展

P0 和 P2 是地址线，P0 是低八位，P2 是高八位。

-------------------------------------------

## 特殊寄存器

### 程序状态字 PSW

位地址|D7|D6|D5|D4|D3|D2|D1|D0
-----|-----|------|-----|----|---|---|---|----
符号|Cy|AC|F0|RS1|RS0|OV|-|P

- Cy: 进位借位标志
- AC：半进位标志
- F0：自定义标志
- RS1/RS0：寄存器组选择位
- OV：溢出标志
- P：奇偶标志，累加器 A 有偶数个位为 1 则 P 等于 0。

> -128 + 128 ，Cy 和 OV 都置 1

### 电源控制寄存器 PCON

位地址|D7|D6|D5|D4|D3|D2|D1|D0
---------|----|---|---|-----|----|----|----|----
名称|SMOD|-|-|-|GF1|GF0|PD|IDL

- SMOD: 波特率倍增
- GF0/ GF1: 通用标志位
- PD: 掉电模式
- IDL: 待机模式 

### 串口控制寄存器 SCON

| 位地址 | 9FH | 9EH | 9DH | 9CH | 9BH | 9AH | 99H | 98H |
| ------ | --- | --- | --- | --- | --- | --- | --- | --- |
| 位符号 | SM0 | SM1 | SM2 | REN | TB8 | RB8 | TI  | RI  |

TI: 发送中断请求标志
RI: 接收中断请求标志
> RI TI 要软件清零。

### 中断允许控制寄存器 IE
位地址|AFH|AEH|ADH|ACH|ABH|AAH|A9H|A8H
-----|---|---|---|---|---|---|---|----
位符号|EA|-|-|ES|ET1|EX1|ET0|EX0

- EA: 总中断开关， 1 为开
- ES: 串行中断开关
- ET: 定时器中断开关
- EX: 外中断开关

### 定时器控制寄存器 TCON

位地址|8FH|8EH|8DH|8CH|8BH|8AH|89H|88H
-----|---|---|----|---|---|---|---|----
位符号|TF1|TR1|TF0|TR0|IE1|IT1|IE0|IT0

- TR : 置 1 后定时器开始工作
- TF : 定时器溢出标志，定时器/计数器产生溢出时置 1 ，并产生中断请求
- IE : 外中断请求标志
- IT : 外中断触发方式控制位。1 为下降沿有效，0 为低电平有效

### 工作方式控制寄存器 TMOD

D7|D6|D5|D4|D3|D2|D1|D0
----|---|-----|---|---|----|----|----
GATE|C/T'|M1|M0|GATE|C/T'|M1|M0

注意： TMOD 不能位寻址

第四位控制定时器0，高四位控制定时器1。

- GATE:  门控
- C/T' :  0 表示定时器，1表示计数器
- M1M0 : 设置工作模式 

### 中断优先级控制寄存器 IP

位地址|BFH|BEH|BDH|BCH|BBH|BAH|B9H|B8H
-----|---|----|---|---|---|---|---|----
位符号|-|-|-|PS|PT1|PX1|PT0|PX0

- PX 外中断优先级设定
- PT 定时器优先级设定
- PS 串行中断优先级设定
> 1 为高优先级，0 为低优先级  
> 同级的顺序是 X0 -> T0 -> X1 -> T1 -> S